<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Digital Photo Request</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4f46e5;
      --primary-light: #6366f1;
      --secondary: #7c3aed;
      --bg: #f8fafc;
      --bg-card: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --success: #059669;
      --error: #dc2626;
      --warning: #d97706;
      --tab-bg: #f1f5f9;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      min-height: 100vh;
      color: var(--text);
    }
    .container { max-width: 1000px; margin: 0 auto; padding: 32px 20px; }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      padding: 20px 24px;
      background: var(--bg-card);
      border-radius: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    h1 { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
    .header-actions { display: flex; gap: 12px; }
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
    }
    .btn-secondary { background: var(--tab-bg); border: 1px solid var(--border); color: var(--text); }
    .btn-secondary:hover { background: var(--border); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover:not(:disabled) { background: var(--primary-light); }
    .btn-danger { background: rgba(220, 38, 38, 0.1); border: 1px solid rgba(220, 38, 38, 0.2); color: var(--error); }
    .btn-danger:hover { background: var(--error); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #047857; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 24px;
      background: var(--bg-card);
      padding: 6px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .tab {
      flex: 1;
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .tab:hover { background: var(--tab-bg); color: var(--text); }
    .tab.active { background: var(--primary); color: white; }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .card h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; color: var(--text); }
    .card p.subtitle { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 20px; }
    
    .generate-section { text-align: center; }
    .code-result {
      margin-top: 24px;
      padding: 20px;
      background: rgba(5, 150, 105, 0.05);
      border: 1px solid rgba(5, 150, 105, 0.15);
      border-radius: 12px;
      display: none;
    }
    .code-result.show { display: block; }
    .code-display {
      font-family: 'JetBrains Mono', monospace;
      font-size: 2rem;
      font-weight: 700;
      color: var(--success);
      margin-bottom: 12px;
      letter-spacing: 4px;
    }
    .code-link { font-size: 0.85rem; color: var(--text-muted); word-break: break-all; }
    .code-link a { color: var(--primary); text-decoration: none; }
    .code-link a:hover { text-decoration: underline; }
    
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); }
    th { font-weight: 600; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; background: var(--tab-bg); }
    td { font-size: 0.9rem; color: var(--text); vertical-align: top; }
    .code-cell { font-family: 'JetBrains Mono', monospace; font-weight: 500; }
    .status { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; display: inline-block; }
    .status.available { background: rgba(5, 150, 105, 0.1); color: var(--success); }
    .status.used { background: rgba(220, 38, 38, 0.1); color: var(--error); }
    .status.pending { background: rgba(217, 119, 6, 0.1); color: var(--warning); }
    .status.paid { background: rgba(79, 70, 229, 0.1); color: var(--primary); }
    .status.approved { background: rgba(5, 150, 105, 0.1); color: var(--success); }
    
    .danger-zone { border-color: rgba(220, 38, 38, 0.2); }
    .danger-zone h2 { color: var(--error); }
    
    .message {
      padding: 14px 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 0.9rem;
      display: none;
    }
    .message.show { display: block; }
    .message.success { background: rgba(5, 150, 105, 0.1); border: 1px solid rgba(5, 150, 105, 0.2); color: var(--success); }
    .message.error { background: rgba(220, 38, 38, 0.1); border: 1px solid rgba(220, 38, 38, 0.2); color: var(--error); }
    
    .empty-state, .loading { text-align: center; padding: 40px; color: var(--text-muted); }
    
    /* Order details */
    .order-details { font-size: 0.85rem; color: var(--text-muted); }
    .order-details strong { color: var(--text); }
    .order-actions { margin-top: 8px; }
    
    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    }
    .modal h3 { font-size: 1.1rem; margin-bottom: 16px; color: var(--text); }
    .modal .form-group { margin-bottom: 16px; }
    .modal label { display: block; font-weight: 500; margin-bottom: 8px; font-size: 0.9rem; color: var(--text); }
    .modal textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: inherit;
      resize: vertical;
      min-height: 120px;
    }
    .modal textarea:focus { outline: none; border-color: var(--primary); }
    .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }
    
    @media (max-width: 768px) {
      .container { padding: 16px; }
      header { flex-direction: column; gap: 12px; align-items: flex-start; }
      .header-actions { width: 100%; }
      th, td { padding: 10px 8px; font-size: 0.8rem; }
      .tabs { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Admin Panel</h1>
      <div class="header-actions">
        <a href="/" class="btn btn-secondary">Back to App</a>
        <button class="btn btn-secondary" onclick="handleLogout()">Logout</button>
      </div>
    </header>
    
    <div id="message" class="message"></div>
    
    <!-- Stats -->
    <div class="card" style="margin-bottom: 24px;">
      <div style="display: flex; align-items: center; gap: 16px;">
        <div style="width: 50px; height: 50px; background: rgba(79, 70, 229, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
          <span style="font-size: 1.5rem;">ðŸ‘¥</span>
        </div>
        <div>
          <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 4px;">Total Registered Users</p>
          <p style="font-size: 1.75rem; font-weight: 700; color: var(--primary);" id="userCount">-</p>
        </div>
      </div>
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="showTab('codes')">Verification Codes</button>
      <button class="tab" onclick="showTab('orders')">User Orders</button>
    </div>
    
    <!-- Tab 1: Codes -->
    <div id="codesTab" class="tab-content active">
      <div class="card">
        <h2>Generate New Code</h2>
        <p class="subtitle">Generate a unique 6-digit verification code with an automatically created Dropbox folder.</p>
        <div class="generate-section">
          <button class="btn btn-primary" onclick="generateCode()" id="generateBtn">Generate New Code</button>
          <div id="codeResult" class="code-result">
            <div class="code-display" id="newCode"></div>
            <div class="code-link">Dropbox: <a id="newLink" href="#" target="_blank"></a></div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h2>All Verification Codes</h2>
        <div id="codesLoading" class="loading">Loading codes...</div>
        <div style="overflow-x: auto;">
          <table id="codesTable" style="display: none;">
            <thead><tr><th>Code</th><th>Status</th><th>Email</th><th>Dropbox</th></tr></thead>
            <tbody id="codesBody"></tbody>
          </table>
        </div>
        <div id="emptyState" class="empty-state" style="display: none;">No codes generated yet.</div>
      </div>
      
      <div class="card danger-zone">
        <h2>Danger Zone</h2>
        <p class="subtitle">This will permanently delete all Dropbox folders and clear all data. This action cannot be undone.</p>
        <button class="btn btn-danger" onclick="clearAllData()" id="clearBtn">Delete All Data</button>
      </div>
    </div>
    
    <!-- Tab 2: Orders -->
    <div id="ordersTab" class="tab-content">
      <div class="card">
        <h2>User Orders</h2>
        <p class="subtitle">View and manage user orders. You can add pickup instructions for each order.</p>
        <div id="ordersLoading" class="loading">Loading orders...</div>
        <div style="overflow-x: auto;">
          <table id="ordersTable" style="display: none;">
            <thead>
              <tr>
                <th>User Email</th>
                <th>Phone</th>
                <th>Country</th>
                <th>Address</th>
                <th>Status</th>
                <th>Pickup Instructions</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ordersBody"></tbody>
          </table>
        </div>
        <div id="ordersEmpty" class="empty-state" style="display: none;">No orders found.</div>
      </div>
    </div>
  </div>
  
  <!-- Modal for Pickup Instructions -->
  <div class="modal-overlay" id="pickupModal">
    <div class="modal">
      <h3>Edit Pickup Instructions</h3>
      <input type="hidden" id="modalOrderId">
      <div class="form-group">
        <label>User Email</label>
        <p id="modalUserEmail" style="color: var(--text-muted);"></p>
      </div>
      <div class="form-group">
        <label>Pickup Instructions</label>
        <textarea id="modalPickupInstructions" placeholder="Enter pickup instructions for this user..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-success" onclick="savePickupInstructions()">Save Instructions</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '';
    
    window.onload = function() {
      const token = localStorage.getItem('authToken');
      if (!token) { window.location.href = '/'; return; }
      verifyAdmin(token);
    };
    
    async function verifyAdmin(token) {
      try {
        const res = await fetch(API_BASE + '/api/auth', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'verify', token }) });
        const data = await res.json();
        if (!data.valid || !data.isAdmin) { window.location.href = '/'; return; }
        loadCodes();
        loadOrders();
        loadUserCount();
      } catch (err) { console.error('Admin verification failed:', err); window.location.href = '/'; }
    }
    
    function getToken() { return localStorage.getItem('authToken'); }
    
    function showMessage(msg, type) {
      const el = document.getElementById('message');
      el.textContent = msg;
      el.className = 'message show ' + type;
      setTimeout(() => el.className = 'message', 5000);
    }
    
    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      
      if (tabName === 'codes') {
        document.querySelector('.tab:nth-child(1)').classList.add('active');
        document.getElementById('codesTab').classList.add('active');
      } else {
        document.querySelector('.tab:nth-child(2)').classList.add('active');
        document.getElementById('ordersTab').classList.add('active');
        loadOrders(); // Refresh when switching to orders tab
      }
    }
    
    async function generateCode() {
      const btn = document.getElementById('generateBtn');
      btn.disabled = true;
      btn.textContent = 'Generating...';
      try {
        const res = await fetch(API_BASE + '/api/admin', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'create-code', token: getToken() }) });
        const data = await res.json();
        if (data.success) {
          document.getElementById('newCode').textContent = data.code;
          document.getElementById('newLink').textContent = data.dropboxLink;
          document.getElementById('newLink').href = data.dropboxLink;
          document.getElementById('codeResult').classList.add('show');
          showMessage('Code generated successfully!', 'success');
          loadCodes();
        } else {
          showMessage(data.message, 'error');
        }
      } catch (err) {
        showMessage('An error occurred. Please try again.', 'error');
      }
      btn.disabled = false;
      btn.textContent = 'Generate New Code';
    }
    
    async function loadCodes() {
      try {
        const res = await fetch(API_BASE + '/api/admin', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'codes', token: getToken() }) });
        const data = await res.json();
        document.getElementById('codesLoading').style.display = 'none';
        
        if (data.success && data.codes.length > 0) {
          document.getElementById('codesTable').style.display = 'table';
          document.getElementById('emptyState').style.display = 'none';
          const tbody = document.getElementById('codesBody');
          tbody.innerHTML = '';
          data.codes.forEach(code => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="code-cell">${code.validationCode}</td>
              <td><span class="status ${code.isUsed ? 'used' : 'available'}">${code.isUsed ? 'Used' : 'Available'}</span></td>
              <td>${code.email || '-'}</td>
              <td>${code.dropboxLink ? `<a href="${code.dropboxLink}" target="_blank" style="color: var(--primary);">View</a>` : '-'}</td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          document.getElementById('codesTable').style.display = 'none';
          document.getElementById('emptyState').style.display = 'block';
        }
      } catch (err) {
        console.error('Failed to load codes:', err);
        document.getElementById('codesLoading').textContent = 'Failed to load codes.';
      }
    }
    
    async function loadOrders() {
      try {
        const res = await fetch(API_BASE + '/api/admin', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'all-orders', token: getToken() }) });
        const data = await res.json();
        document.getElementById('ordersLoading').style.display = 'none';
        
        if (data.success && data.orders && data.orders.length > 0) {
          document.getElementById('ordersTable').style.display = 'table';
          document.getElementById('ordersEmpty').style.display = 'none';
          const tbody = document.getElementById('ordersBody');
          tbody.innerHTML = '';
          
          data.orders.forEach(order => {
            const tr = document.createElement('tr');
            const statusClass = order.status.replace(/_/g, '-');
            const canSendEmail = order.status === 'approved' && order.pickup_instructions;
            tr.innerHTML = `
              <td><strong>${order.user_email}</strong></td>
              <td>${order.phone || '-'}</td>
              <td>${order.country || '-'}</td>
              <td style="max-width: 150px; white-space: pre-wrap; word-break: break-word;">${order.address || '-'}</td>
              <td><span class="status ${statusClass}">${order.status.replace(/_/g, ' ')}</span></td>
              <td style="max-width: 200px; white-space: pre-wrap; word-break: break-word;">${order.pickup_instructions || '<em style="color: var(--text-muted);">Not set</em>'}</td>
              <td>
                <div style="display: flex; flex-direction: column; gap: 6px;">
                  <button class="btn btn-primary btn-sm" onclick="openPickupModal('${order.id}', '${order.user_email}', \`${(order.pickup_instructions || '').replace(/`/g, '\\`')}\`)">
                    Edit Instructions
                  </button>
                  ${canSendEmail ? `
                    <button class="btn btn-success btn-sm" onclick="sendReadyEmail('${order.id}', '${order.user_email}')">
                      Send Ready Email
                    </button>
                  ` : (order.status === 'completed' ? '<span style="color: var(--success); font-size: 0.8rem;">âœ“ Email sent</span>' : '')}
                </div>
              </td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          document.getElementById('ordersTable').style.display = 'none';
          document.getElementById('ordersEmpty').style.display = 'block';
        }
      } catch (err) {
        console.error('Failed to load orders:', err);
        document.getElementById('ordersLoading').textContent = 'Failed to load orders.';
      }
    }
    
    function openPickupModal(orderId, userEmail, instructions) {
      document.getElementById('modalOrderId').value = orderId;
      document.getElementById('modalUserEmail').textContent = userEmail;
      document.getElementById('modalPickupInstructions').value = instructions || '';
      document.getElementById('pickupModal').classList.add('show');
    }
    
    function closeModal() {
      document.getElementById('pickupModal').classList.remove('show');
    }
    
    async function savePickupInstructions() {
      const orderId = document.getElementById('modalOrderId').value;
      const instructions = document.getElementById('modalPickupInstructions').value;
      
      try {
        const res = await fetch(API_BASE + '/api/admin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'update-pickup',
            token: getToken(),
            orderId: orderId,
            pickupInstructions: instructions
          })
        });
        const data = await res.json();
        
        if (data.success) {
          showMessage('Pickup instructions saved!', 'success');
          closeModal();
          loadOrders();
        } else {
          showMessage(data.message, 'error');
        }
      } catch (err) {
        showMessage('Failed to save instructions.', 'error');
      }
    }
    
    async function sendReadyEmail(orderId, userEmail) {
      if (!confirm(`Send "Ready for Pickup" email to ${userEmail}?`)) return;
      
      try {
        const res = await fetch(API_BASE + '/api/admin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'send-ready-email',
            token: getToken(),
            orderId: orderId
          })
        });
        const data = await res.json();
        
        if (data.success) {
          showMessage('Email sent successfully!', 'success');
          loadOrders(); // Refresh to show updated status
        } else {
          showMessage(data.message, 'error');
        }
      } catch (err) {
        showMessage('Failed to send email.', 'error');
      }
    }
    
    async function clearAllData() {
      if (!confirm('Are you sure you want to delete ALL data? This cannot be undone.')) return;
      if (!confirm('This will delete all Dropbox folders. Continue?')) return;
      
      const btn = document.getElementById('clearBtn');
      btn.disabled = true;
      btn.textContent = 'Deleting...';
      
      try {
        const res = await fetch(API_BASE + '/api/admin', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'clear-all', token: getToken() }) });
        const data = await res.json();
        if (data.success) {
          showMessage(data.message, 'success');
          document.getElementById('codeResult').classList.remove('show');
          loadCodes();
          loadOrders();
        } else {
          showMessage(data.message, 'error');
        }
      } catch (err) {
        showMessage('An error occurred. Please try again.', 'error');
      }
      btn.disabled = false;
      btn.textContent = 'Delete All Data';
    }
    
    async function loadUserCount() {
      try {
        const res = await fetch(API_BASE + '/api/admin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'user-count', token: getToken() })
        });
        const data = await res.json();
        if (data.success) {
          document.getElementById('userCount').textContent = data.count;
        }
      } catch (err) {
        console.error('Failed to load user count:', err);
      }
    }
    
    function handleLogout() {
      localStorage.removeItem('authToken');
      localStorage.removeItem('userEmail');
      window.location.href = '/';
    }
  </script>
</body>
</html>
